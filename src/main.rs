use bytes::{BufMut, BytesMut};
use zerocopy::{FromBytes as _, IntoBytes as _};
mod ffi;
use std::mem::MaybeUninit;
use std::net::{IpAddr, Ipv4Addr, Ipv6Addr};

use color_eyre::eyre;
use libc::{
    AF_INET, AF_INET6, AF_PACKET, IFA_ADDRESS, IFA_F_DADFAILED, IFA_F_DEPRECATED,
    IFA_F_HOMEADDRESS, IFA_F_TENTATIVE, IFA_FLAGS, IFA_LABEL, IFA_LOCAL, NETLINK_ROUTE, NLM_F_DUMP,
    NLM_F_REQUEST, RTM_DELADDR, RTM_GETADDR, RTM_NEWADDR, RTMGRP_IPV4_IFADDR, RTMGRP_IPV6_IFADDR,
    RTMGRP_LINK,
};
use zerocopy::{FromBytes as _, IntoBytes as _};

use crate::ffi::{
    IFA_PAYLOAD, NLMSG_ALIGN, NLMSG_ALIGNTO, NLMSG_HDRLEN, NLMSG_LENGTH, NLMSG_PAYLOAD,
    NLMSG_SPACE, RTA_ALIGNTO, ifaddrmsg, netlink_req, nlmsghdr, rta_type_to_label, rtattr, *,
};

#[derive(Debug)]
pub enum Command {
    NewAddress {
        address: IpAddr,
        scope: u8,
        index: u32,
    },
    DeleteAddress {
        address: IpAddr,
        scope: u8,
        index: u32,
    },
}

fn align_to(offset: usize, align_to: usize) -> usize {
    // this doesn't work for offset = 0
    // offset + align_to - (offset % align_to)

    offset.div_ceil(align_to) * align_to
}


const KERNEL_DATA: [u8; 3776] = [
    76, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 8, 128, 254, 1, 0, 0, 0, 8, 0, 1, 0,
    127, 0, 0, 1, 8, 0, 2, 0, 127, 0, 0, 1, 7, 0, 3, 0, 108, 111, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 194, 0, 0, 0, 194, 0, 0, 0, 88, 0, 0, 0,
    20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 24, 128, 0, 2, 0, 0, 0, 8, 0, 1, 0, 192, 168, 12,
    5, 8, 0, 2, 0, 192, 168, 12, 5, 8, 0, 4, 0, 192, 168, 12, 255, 11, 0, 3, 0, 101, 110, 112, 52,
    115, 48, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255,
    242, 3, 0, 0, 242, 3, 0, 0, 92, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 24, 128,
    0, 4, 0, 0, 0, 8, 0, 1, 0, 192, 168, 40, 5, 8, 0, 2, 0, 192, 168, 40, 5, 8, 0, 4, 0, 192, 168,
    40, 255, 14, 0, 3, 0, 101, 110, 112, 52, 115, 48, 46, 52, 48, 0, 0, 0, 8, 0, 8, 0, 128, 0, 0,
    0, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 3, 3, 0, 0, 243, 3, 0, 0, 92, 0, 0, 0,
    20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 24, 128, 0, 5, 0, 0, 0, 8, 0, 1, 0, 192, 168, 20,
    5, 8, 0, 2, 0, 192, 168, 20, 5, 8, 0, 4, 0, 192, 168, 20, 255, 14, 0, 3, 0, 101, 110, 112, 52,
    115, 48, 46, 50, 48, 0, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6, 0, 255, 255, 255, 255, 255,
    255, 255, 255, 3, 3, 0, 0, 243, 3, 0, 0, 84, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    2, 32, 128, 0, 6, 0, 0, 0, 8, 0, 1, 0, 100, 111, 79, 121, 8, 0, 2, 0, 100, 111, 79, 121, 15, 0,
    3, 0, 116, 97, 105, 108, 115, 99, 97, 108, 101, 48, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6,
    0, 255, 255, 255, 255, 255, 255, 255, 255, 174, 4, 0, 0, 174, 4, 0, 0, 96, 0, 0, 0, 20, 0, 2,
    0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 23, 128, 0, 7, 0, 0, 0, 8, 0, 1, 0, 172, 19, 0, 1, 8, 0, 2,
    0, 172, 19, 0, 1, 8, 0, 4, 0, 172, 19, 1, 255, 18, 0, 3, 0, 100, 111, 99, 107, 101, 114, 45,
    98, 114, 105, 100, 103, 101, 0, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6, 0, 255, 255, 255,
    255, 255, 255, 255, 255, 249, 4, 0, 0, 249, 4, 0, 0, 88, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78,
    161, 33, 0, 2, 16, 128, 0, 8, 0, 0, 0, 8, 0, 1, 0, 172, 17, 0, 1, 8, 0, 2, 0, 172, 17, 0, 1, 8,
    0, 4, 0, 172, 17, 255, 255, 12, 0, 3, 0, 100, 111, 99, 107, 101, 114, 48, 0, 8, 0, 8, 0, 128,
    0, 0, 0, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 253, 4, 0, 0, 253, 4, 0, 0, 72,
    0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 128, 128, 254, 1, 0, 0, 0, 20, 0, 1, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 194, 0, 0, 0, 194, 0, 0, 0, 8, 0, 8, 0, 128, 2, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 0, 0, 2, 0, 0, 0, 20, 0, 1, 0, 38, 0, 136, 0, 182, 244, 76, 0, 214,
    93, 223, 255, 254, 30, 17, 169, 20, 0, 6, 0, 25, 40, 1, 0, 25, 40, 1, 0, 249, 4, 0, 0, 84, 103,
    151, 1, 8, 0, 8, 0, 0, 3, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64,
    128, 253, 2, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 214, 93, 223, 255, 254, 30, 17,
    169, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 241, 3, 0, 0, 241, 3, 0, 0, 8, 0, 8,
    0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 4, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 214, 93, 223, 255, 254,
    30, 17, 169, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 241, 3, 0, 0, 241, 3, 0, 0,
    8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78,
    161, 33, 0, 10, 64, 128, 253, 5, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 214, 93,
    223, 255, 254, 30, 17, 169, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 241, 3, 0, 0,
    241, 3, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1,
    0, 0, 0, 78, 161, 33, 0, 10, 128, 128, 0, 6, 0, 0, 0, 20, 0, 1, 0, 253, 122, 17, 92, 161, 224,
    0, 0, 0, 0, 0, 0, 107, 1, 79, 121, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 174, 4,
    0, 0, 174, 4, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 6, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 200, 226, 254,
    22, 17, 125, 50, 84, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 23, 3, 0, 0, 23, 3,
    0, 0, 8, 0, 8, 0, 128, 8, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0,
    78, 161, 33, 0, 10, 64, 128, 253, 7, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 224, 91,
    156, 255, 254, 93, 138, 26, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 120, 5, 0, 0,
    120, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1,
    0, 0, 0, 78, 161, 33, 0, 10, 48, 130, 0, 8, 0, 0, 0, 20, 0, 1, 0, 253, 168, 74, 225, 119, 85,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 253, 4, 0,
    0, 39, 5, 0, 0, 8, 0, 8, 0, 130, 0, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 130, 0, 9, 0, 0, 0, 20, 0, 1, 0, 38, 0, 136, 0, 182, 244, 76, 16, 0, 0, 0, 0, 0, 0, 0,
    1, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 2, 5, 0, 0, 2, 5, 0, 0, 8, 0, 8, 0,
    130, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 9, 0, 0,
    0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 200, 92, 137, 255, 254, 220, 137, 245, 20, 0, 6, 0,
    255, 255, 255, 255, 255, 255, 255, 255, 196, 5, 0, 0, 196, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 10, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 144, 158, 147, 255, 254, 230, 199,
    183, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 120, 5, 0, 0, 120, 5, 0, 0, 8, 0, 8,
    0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 11, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 16, 178, 8, 255, 254,
    86, 122, 24, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 122, 5, 0, 0, 122, 5, 0, 0,
    8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78,
    161, 33, 0, 10, 64, 128, 253, 13, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 208, 43,
    124, 255, 254, 153, 110, 65, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 132, 5, 0, 0,
    132, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1,
    0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 15, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0,
    0, 28, 23, 250, 255, 254, 184, 114, 92, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255,
    149, 5, 0, 0, 149, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20,
    0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 16, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0,
    0, 0, 0, 0, 0, 168, 31, 217, 255, 254, 240, 222, 111, 20, 0, 6, 0, 255, 255, 255, 255, 255,
    255, 255, 255, 148, 5, 0, 0, 148, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0,
    80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 17, 0, 0, 0, 20, 0, 1,
    0, 254, 128, 0, 0, 0, 0, 0, 0, 132, 51, 59, 255, 254, 112, 180, 75, 20, 0, 6, 0, 255, 255, 255,
    255, 255, 255, 255, 255, 158, 5, 0, 0, 158, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3,
    0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 20, 0, 0, 0,
    20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 244, 214, 200, 255, 254, 45, 164, 90, 20, 0, 6, 0,
    255, 255, 255, 255, 255, 255, 255, 255, 175, 5, 0, 0, 175, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 21, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 228, 105, 30, 255, 254, 129, 67, 80,
    20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 178, 5, 0, 0, 178, 5, 0, 0, 8, 0, 8, 0,
    128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 22, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 116, 9, 81, 255, 254,
    24, 107, 4, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 189, 5, 0, 0, 189, 5, 0, 0, 8,
    0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 23, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 44, 36, 181,
    255, 254, 213, 111, 45, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 190, 5, 0, 0, 190,
    5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 128, 253, 24, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 212,
    219, 226, 255, 254, 22, 133, 49, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 200, 5,
    0, 0, 200, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2,
    0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 25, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0,
    0, 0, 0, 152, 37, 113, 255, 254, 162, 136, 152, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 196, 5, 0, 0, 196, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0,
    0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 26, 0, 0, 0, 20, 0, 1, 0, 254,
    128, 0, 0, 0, 0, 0, 0, 20, 17, 246, 255, 254, 78, 143, 168, 20, 0, 6, 0, 255, 255, 255, 255,
    255, 255, 255, 255, 202, 5, 0, 0, 202, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0,
    0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 27, 0, 0, 0, 20, 0,
    1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 112, 62, 26, 255, 254, 39, 202, 191, 20, 0, 6, 0, 255, 255,
    255, 255, 255, 255, 255, 255, 219, 5, 0, 0, 219, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11,
    0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 30, 0,
    0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 64, 58, 104, 255, 254, 72, 198, 48, 20, 0, 6, 0,
    255, 255, 255, 255, 255, 255, 255, 255, 232, 5, 0, 0, 232, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 31, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 196, 30, 183, 255, 254, 211, 96,
    144, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 233, 5, 0, 0, 233, 5, 0, 0, 8, 0, 8,
    0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 32, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 120, 80, 138, 255, 254,
    197, 252, 205, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 0, 6, 0, 0, 0, 6, 0, 0, 8,
    0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 33, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 156, 182, 53,
    255, 254, 184, 34, 252, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 252, 5, 0, 0, 252,
    5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 128, 253, 34, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 120,
    58, 22, 255, 254, 4, 155, 202, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 254, 5, 0,
    0, 254, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0,
    1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 35, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0,
    0, 0, 216, 221, 57, 255, 254, 253, 127, 229, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 2, 6, 0, 0, 2, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0,
    20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 37, 0, 0, 0, 20, 0, 1, 0, 254, 128,
    0, 0, 0, 0, 0, 0, 180, 237, 76, 255, 254, 16, 162, 209, 20, 0, 6, 0, 255, 255, 255, 255, 255,
    255, 255, 255, 30, 6, 0, 0, 30, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80,
    0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 39, 0, 0, 0, 20, 0, 1, 0,
    254, 128, 0, 0, 0, 0, 0, 0, 232, 93, 203, 255, 254, 151, 242, 192, 20, 0, 6, 0, 255, 255, 255,
    255, 255, 255, 255, 255, 24, 6, 0, 0, 24, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0,
    0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 41, 0, 0, 0, 20,
    0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 236, 94, 172, 255, 254, 55, 172, 195, 20, 0, 6, 0, 255,
    255, 255, 255, 255, 255, 255, 255, 36, 6, 0, 0, 36, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0,
    11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 42,
    0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 184, 147, 237, 255, 254, 123, 87, 197, 20, 0,
    6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 62, 6, 0, 0, 62, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0,
    0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 43, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 52, 128, 11, 255, 254, 206, 103,
    115, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 51, 6, 0, 0, 51, 6, 0, 0, 8, 0, 8, 0,
    128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 45, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 156, 146, 52, 255, 254,
    27, 28, 202, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 94, 6, 0, 0, 94, 6, 0, 0, 8,
    0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 46, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 88, 188, 125,
    255, 254, 33, 229, 218, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 102, 6, 0, 0, 102,
    6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 128, 253, 47, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 64,
    223, 171, 255, 254, 132, 71, 191, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 105, 6,
    0, 0, 105, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2,
    0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 48, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0,
    0, 0, 0, 180, 117, 151, 255, 254, 21, 252, 108, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 108, 6, 0, 0, 108, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0,
];


fn receive_data( to: &mut impl BufMut) -> usize {
    for byte in KERNEL_DATA {
        to.put_u8(byte);
    }

    KERNEL_DATA.len()
}

fn main() -> Result<(), eyre::Report> {
    // we originally had this on the stack (array) but tokio then moves the whole task to the heap because of size

    // we don't need to zero out the buffer between runs as `recv_buf` starts at 0 and returns `bytes_read`
    // sine we only read that portion we don't need to worry about the leftovers
    let mut buffer = vec![MaybeUninit::<u32>::uninit(); 1024];

    let bytes_read = {
        // SAFETY: created from a valid vector, so all the slice quarantees are upheld
        let mut buffer_byte_cursor = unsafe {
            std::slice::from_raw_parts_mut(
                buffer.as_mut_ptr().cast::<MaybeUninit<u8>>(),
                buffer.len() * std::mem::size_of::<MaybeUninit<u32>>(),
            )
        };

        receive_data( &mut buffer_byte_cursor)
    };

    println!("netlink message with {} bytes", bytes_read);

    // SAFETY: created from a valid vector, so all the slice quarantees are upheld
    let buffer = unsafe {
        std::slice::from_raw_parts(
            buffer.as_ptr().cast::<MaybeUninit<u8>>(),
            buffer.len() * std::mem::size_of::<MaybeUninit<u32>>(),
        )
    };

    // SAFETY: we are only initializing the parts of the buffer `recv_buf_from` has written to
    let buffer = unsafe { &*(&raw const buffer[..bytes_read] as *const [u8]) };

    let mut message_offset = 0;

    while message_offset < bytes_read {
        let (message, _suffix) = nlmsghdr::ref_from_prefix(&buffer[message_offset..])
            .map_err(|error| eyre::Report::msg(error.to_string()))?;

        if message.nlmsg_type != RTM_NEWADDR && message.nlmsg_type != RTM_DELADDR {
            println!("invalid rtm_message type {}", message.nlmsg_type);

            // skip this message and its data
            message_offset += align_to(message.nlmsg_len as usize, NLMSG_ALIGNTO as usize);

            continue;
        }

        let current_message_data_start =
            message_offset + align_to(size_of::<nlmsghdr>(), NLMSG_ALIGNTO as usize);

        // decode ifaddrmsg as in if_addr.h
        let (ifa, _suffix) = ifaddrmsg::ref_from_prefix(&buffer[current_message_data_start..])
            .map_err(|error| eyre::Report::msg(error.to_string()))?;

        let ifa_flags = u32::from(ifa.ifa_flags);

        if ((ifa_flags) & IFA_F_DADFAILED == IFA_F_DADFAILED)
            || (ifa_flags & IFA_F_HOMEADDRESS == IFA_F_HOMEADDRESS)
            || (ifa_flags & IFA_F_DEPRECATED == IFA_F_DEPRECATED)
            || (ifa_flags & IFA_F_TENTATIVE == IFA_F_TENTATIVE)
        {
            println!("ignore address with invalid state {:#x}", ifa_flags);

            // skip this message and its data
            message_offset += align_to(message.nlmsg_len as usize, NLMSG_ALIGNTO as usize);

            continue;
        }

        println!(
            "RTM new/del addr family: {} flags: {} scope: {} idx: {}",
            ifa.ifa_family, ifa.ifa_flags, ifa.ifa_scope, ifa.ifa_index
        );

        let mut addr: Option<IpAddr> = None;

        let data_length = message.nlmsg_len as usize
            - (align_to(
                size_of::<ifaddrmsg>() + align_to(size_of::<nlmsghdr>(), NLMSG_ALIGNTO as usize),
                NLMSG_ALIGNTO as usize,
            ));

        let mut attribute_offset =
            current_message_data_start + align_to(size_of::<ifaddrmsg>(), NLMSG_ALIGNTO as usize);

        #[expect(clippy::big_endian_bytes, reason = "We're reading network data")]
        while attribute_offset - current_message_data_start <= data_length {
            let rta = match rtattr::ref_from_prefix(&buffer[attribute_offset..]) {
                Ok((rta, _suffix)) => rta,
                Err(error) => {
                    println!("{:?} Error mapping buffer to `rtattr`", error);

                    // TODO use thiserror
                    return Err(eyre::Report::msg(
                        "ConvertError: Error mapping buffer to `rtattr`",
                    ));
                },
            };

            println!(
                "rt_attr {} {}: ({})",
                rta.rta_len,
                rta.rta_type,
                rta_type_to_label(rta.rta_type).unwrap_or("Unknown type")
            );

            if usize::from(rta.rta_len) < size_of::<rtattr>() {
                println!("Invalid `rta_len`. skipping remainder.");
                break;
            }

            if rta.rta_type == IFA_LABEL {
                // unused, original codebase extracted
                // the labels in here for ipv4, but ipv6 requires another way
                // we do both the ipv6 way
            } else if rta.rta_type == IFA_LOCAL && i32::from(ifa.ifa_family) == AF_INET {
                let (ipv4_in_network_order, _suffix) =
                    <[u8; 4]>::ref_from_prefix(&buffer[attribute_offset + size_of::<rtattr>()..])
                        .unwrap();

                addr = Some(Ipv4Addr::from_bits(u32::from_be_bytes(*ipv4_in_network_order)).into());
            } else if rta.rta_type == IFA_ADDRESS && i32::from(ifa.ifa_family) == AF_INET6 {
                let (ipv6_in_network_order, _suffix) =
                    <[u8; 16]>::ref_from_prefix(&buffer[attribute_offset + size_of::<rtattr>()..])
                        .unwrap();

                addr =
                    Some(Ipv6Addr::from_bits(u128::from_be_bytes(*ipv6_in_network_order)).into());
            } else if rta.rta_type == IFA_FLAGS {

                // https://github.com/torvalds/linux/blob/febbc555cf0fff895546ddb8ba2c9a523692fb55/include/uapi/linux/if_addr.h#L35
                // unused
                // original:
                // _, ifa_flags = struct.unpack_from('HI', buf, i)
            } else {
                // ...
            }

            attribute_offset += align_to(usize::from(rta.rta_len), RTA_ALIGNTO as usize);
        }

        let Some(addr) = addr else {
            println!("no address in RTM message");
            message_offset += align_to(data_length, NLMSG_ALIGNTO as usize);
            continue;
        };

        let command = if message.nlmsg_type == RTM_NEWADDR {
            Command::NewAddress {
                address: addr,
                scope: ifa.ifa_scope,
                index: ifa.ifa_index,
            }
        } else if message.nlmsg_type == RTM_DELADDR {
            Command::DeleteAddress {
                address: addr,
                scope: ifa.ifa_scope,
                index: ifa.ifa_index,
            }
        } else {
            // unreachable because we checked above
            unreachable!()
        };

        println!("{:?}", command);
        // if let Err(error) = self.command_tx.send(command).await {
        //     if self.cancellation_token.is_cancelled() {
        //         println!( command = ?error.0, "Could not announce command due to shutting down");
        //         break;
        //     } else {
        //         println!( command = ?error.0, "Failed to announce command");
        //     }
        // }

        message_offset += message.nlmsg_len as usize;
    }

    Ok(())
}
