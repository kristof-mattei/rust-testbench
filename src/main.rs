mod utils;
use color_eyre::eyre;
use ipnet::IpNet;
use tokio::time::sleep;
use tracing::{Level, event};
mod kernel_buffer;
use bytes::BufMut;
mod ffi;
use std::net::{Ipv4Addr, Ipv6Addr};
use std::time::Duration;

use libc::{
    AF_INET, AF_INET6, IFA_ADDRESS, IFA_F_DADFAILED, IFA_F_DEPRECATED, IFA_F_HOMEADDRESS,
    IFA_F_TENTATIVE, IFA_FLAGS, IFA_LABEL, IFA_LOCAL, NLMSG_DONE, RTM_DELADDR, RTM_NEWADDR,
};

use crate::ffi::{
    IFA_PAYLOAD, IFA_RTA, NLMSG_DATA, NLMSG_NEXT, NLMSG_OK, RTA_DATA, RTA_NEXT, RTA_OK, SendPtr,
    ifaddrmsg, nlmsghdr,
};
use crate::kernel_buffer::AlignedBuffer;
use crate::utils::flatten_handle;

#[derive(Debug)]
pub enum Command {
    NewAddress {
        address: IpNet,
        scope: u8,
        index: u32,
    },
    DeleteAddress {
        address: IpNet,
        scope: u8,
        index: u32,
    },
}

const KERNEL_DATA: [u8; 3776] = [
    76, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 8, 128, 254, 1, 0, 0, 0, 8, 0, 1, 0,
    127, 0, 0, 1, 8, 0, 2, 0, 127, 0, 0, 1, 7, 0, 3, 0, 108, 111, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 194, 0, 0, 0, 194, 0, 0, 0, 88, 0, 0, 0,
    20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 24, 128, 0, 2, 0, 0, 0, 8, 0, 1, 0, 192, 168, 12,
    5, 8, 0, 2, 0, 192, 168, 12, 5, 8, 0, 4, 0, 192, 168, 12, 255, 11, 0, 3, 0, 101, 110, 112, 52,
    115, 48, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255,
    242, 3, 0, 0, 242, 3, 0, 0, 92, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 24, 128,
    0, 4, 0, 0, 0, 8, 0, 1, 0, 192, 168, 40, 5, 8, 0, 2, 0, 192, 168, 40, 5, 8, 0, 4, 0, 192, 168,
    40, 255, 14, 0, 3, 0, 101, 110, 112, 52, 115, 48, 46, 52, 48, 0, 0, 0, 8, 0, 8, 0, 128, 0, 0,
    0, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 3, 3, 0, 0, 243, 3, 0, 0, 92, 0, 0, 0,
    20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 24, 128, 0, 5, 0, 0, 0, 8, 0, 1, 0, 192, 168, 20,
    5, 8, 0, 2, 0, 192, 168, 20, 5, 8, 0, 4, 0, 192, 168, 20, 255, 14, 0, 3, 0, 101, 110, 112, 52,
    115, 48, 46, 50, 48, 0, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6, 0, 255, 255, 255, 255, 255,
    255, 255, 255, 3, 3, 0, 0, 243, 3, 0, 0, 84, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    2, 32, 128, 0, 6, 0, 0, 0, 8, 0, 1, 0, 100, 111, 79, 121, 8, 0, 2, 0, 100, 111, 79, 121, 15, 0,
    3, 0, 116, 97, 105, 108, 115, 99, 97, 108, 101, 48, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6,
    0, 255, 255, 255, 255, 255, 255, 255, 255, 174, 4, 0, 0, 174, 4, 0, 0, 96, 0, 0, 0, 20, 0, 2,
    0, 1, 0, 0, 0, 78, 161, 33, 0, 2, 23, 128, 0, 7, 0, 0, 0, 8, 0, 1, 0, 172, 19, 0, 1, 8, 0, 2,
    0, 172, 19, 0, 1, 8, 0, 4, 0, 172, 19, 1, 255, 18, 0, 3, 0, 100, 111, 99, 107, 101, 114, 45,
    98, 114, 105, 100, 103, 101, 0, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 20, 0, 6, 0, 255, 255, 255,
    255, 255, 255, 255, 255, 249, 4, 0, 0, 249, 4, 0, 0, 88, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78,
    161, 33, 0, 2, 16, 128, 0, 8, 0, 0, 0, 8, 0, 1, 0, 172, 17, 0, 1, 8, 0, 2, 0, 172, 17, 0, 1, 8,
    0, 4, 0, 172, 17, 255, 255, 12, 0, 3, 0, 100, 111, 99, 107, 101, 114, 48, 0, 8, 0, 8, 0, 128,
    0, 0, 0, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 253, 4, 0, 0, 253, 4, 0, 0, 72,
    0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 128, 128, 254, 1, 0, 0, 0, 20, 0, 1, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 194, 0, 0, 0, 194, 0, 0, 0, 8, 0, 8, 0, 128, 2, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 0, 0, 2, 0, 0, 0, 20, 0, 1, 0, 38, 0, 136, 0, 182, 244, 76, 0, 214,
    93, 223, 255, 254, 30, 17, 169, 20, 0, 6, 0, 25, 40, 1, 0, 25, 40, 1, 0, 249, 4, 0, 0, 84, 103,
    151, 1, 8, 0, 8, 0, 0, 3, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64,
    128, 253, 2, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 214, 93, 223, 255, 254, 30, 17,
    169, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 241, 3, 0, 0, 241, 3, 0, 0, 8, 0, 8,
    0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 4, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 214, 93, 223, 255, 254,
    30, 17, 169, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 241, 3, 0, 0, 241, 3, 0, 0,
    8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78,
    161, 33, 0, 10, 64, 128, 253, 5, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 214, 93,
    223, 255, 254, 30, 17, 169, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 241, 3, 0, 0,
    241, 3, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1,
    0, 0, 0, 78, 161, 33, 0, 10, 128, 128, 0, 6, 0, 0, 0, 20, 0, 1, 0, 253, 122, 17, 92, 161, 224,
    0, 0, 0, 0, 0, 0, 107, 1, 79, 121, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 174, 4,
    0, 0, 174, 4, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 6, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 200, 226, 254,
    22, 17, 125, 50, 84, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 23, 3, 0, 0, 23, 3,
    0, 0, 8, 0, 8, 0, 128, 8, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0,
    78, 161, 33, 0, 10, 64, 128, 253, 7, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 224, 91,
    156, 255, 254, 93, 138, 26, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 120, 5, 0, 0,
    120, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1,
    0, 0, 0, 78, 161, 33, 0, 10, 48, 130, 0, 8, 0, 0, 0, 20, 0, 1, 0, 253, 168, 74, 225, 119, 85,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 253, 4, 0,
    0, 39, 5, 0, 0, 8, 0, 8, 0, 130, 0, 0, 0, 72, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 130, 0, 9, 0, 0, 0, 20, 0, 1, 0, 38, 0, 136, 0, 182, 244, 76, 16, 0, 0, 0, 0, 0, 0, 0,
    1, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 2, 5, 0, 0, 2, 5, 0, 0, 8, 0, 8, 0,
    130, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 9, 0, 0,
    0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 200, 92, 137, 255, 254, 220, 137, 245, 20, 0, 6, 0,
    255, 255, 255, 255, 255, 255, 255, 255, 196, 5, 0, 0, 196, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 10, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 144, 158, 147, 255, 254, 230, 199,
    183, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 120, 5, 0, 0, 120, 5, 0, 0, 8, 0, 8,
    0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 11, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 16, 178, 8, 255, 254,
    86, 122, 24, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 122, 5, 0, 0, 122, 5, 0, 0,
    8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78,
    161, 33, 0, 10, 64, 128, 253, 13, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 208, 43,
    124, 255, 254, 153, 110, 65, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 132, 5, 0, 0,
    132, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1,
    0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 15, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0,
    0, 28, 23, 250, 255, 254, 184, 114, 92, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255,
    149, 5, 0, 0, 149, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20,
    0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 16, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0,
    0, 0, 0, 0, 0, 168, 31, 217, 255, 254, 240, 222, 111, 20, 0, 6, 0, 255, 255, 255, 255, 255,
    255, 255, 255, 148, 5, 0, 0, 148, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0,
    80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 17, 0, 0, 0, 20, 0, 1,
    0, 254, 128, 0, 0, 0, 0, 0, 0, 132, 51, 59, 255, 254, 112, 180, 75, 20, 0, 6, 0, 255, 255, 255,
    255, 255, 255, 255, 255, 158, 5, 0, 0, 158, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3,
    0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 20, 0, 0, 0,
    20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 244, 214, 200, 255, 254, 45, 164, 90, 20, 0, 6, 0,
    255, 255, 255, 255, 255, 255, 255, 255, 175, 5, 0, 0, 175, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 21, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 228, 105, 30, 255, 254, 129, 67, 80,
    20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 178, 5, 0, 0, 178, 5, 0, 0, 8, 0, 8, 0,
    128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 22, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 116, 9, 81, 255, 254,
    24, 107, 4, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 189, 5, 0, 0, 189, 5, 0, 0, 8,
    0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 23, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 44, 36, 181,
    255, 254, 213, 111, 45, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 190, 5, 0, 0, 190,
    5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 128, 253, 24, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 212,
    219, 226, 255, 254, 22, 133, 49, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 200, 5,
    0, 0, 200, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2,
    0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 25, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0,
    0, 0, 0, 152, 37, 113, 255, 254, 162, 136, 152, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 196, 5, 0, 0, 196, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0,
    0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 26, 0, 0, 0, 20, 0, 1, 0, 254,
    128, 0, 0, 0, 0, 0, 0, 20, 17, 246, 255, 254, 78, 143, 168, 20, 0, 6, 0, 255, 255, 255, 255,
    255, 255, 255, 255, 202, 5, 0, 0, 202, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0,
    0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 27, 0, 0, 0, 20, 0,
    1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 112, 62, 26, 255, 254, 39, 202, 191, 20, 0, 6, 0, 255, 255,
    255, 255, 255, 255, 255, 255, 219, 5, 0, 0, 219, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11,
    0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 30, 0,
    0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 64, 58, 104, 255, 254, 72, 198, 48, 20, 0, 6, 0,
    255, 255, 255, 255, 255, 255, 255, 255, 232, 5, 0, 0, 232, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0,
    5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 31, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 196, 30, 183, 255, 254, 211, 96,
    144, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 233, 5, 0, 0, 233, 5, 0, 0, 8, 0, 8,
    0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 32, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 120, 80, 138, 255, 254,
    197, 252, 205, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 0, 6, 0, 0, 0, 6, 0, 0, 8,
    0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 33, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 156, 182, 53,
    255, 254, 184, 34, 252, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 252, 5, 0, 0, 252,
    5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 128, 253, 34, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 120,
    58, 22, 255, 254, 4, 155, 202, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 254, 5, 0,
    0, 254, 5, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0,
    1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 35, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0,
    0, 0, 216, 221, 57, 255, 254, 253, 127, 229, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 2, 6, 0, 0, 2, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0,
    20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 37, 0, 0, 0, 20, 0, 1, 0, 254, 128,
    0, 0, 0, 0, 0, 0, 180, 237, 76, 255, 254, 16, 162, 209, 20, 0, 6, 0, 255, 255, 255, 255, 255,
    255, 255, 255, 30, 6, 0, 0, 30, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80,
    0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 39, 0, 0, 0, 20, 0, 1, 0,
    254, 128, 0, 0, 0, 0, 0, 0, 232, 93, 203, 255, 254, 151, 242, 192, 20, 0, 6, 0, 255, 255, 255,
    255, 255, 255, 255, 255, 24, 6, 0, 0, 24, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0,
    0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 41, 0, 0, 0, 20,
    0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 236, 94, 172, 255, 254, 55, 172, 195, 20, 0, 6, 0, 255,
    255, 255, 255, 255, 255, 255, 255, 36, 6, 0, 0, 36, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0,
    11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 42,
    0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 184, 147, 237, 255, 254, 123, 87, 197, 20, 0,
    6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 62, 6, 0, 0, 62, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0,
    0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128,
    253, 43, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 52, 128, 11, 255, 254, 206, 103,
    115, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 51, 6, 0, 0, 51, 6, 0, 0, 8, 0, 8, 0,
    128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161, 33, 0,
    10, 64, 128, 253, 45, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 156, 146, 52, 255, 254,
    27, 28, 202, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 94, 6, 0, 0, 94, 6, 0, 0, 8,
    0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0, 0, 78, 161,
    33, 0, 10, 64, 128, 253, 46, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 88, 188, 125,
    255, 254, 33, 229, 218, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 102, 6, 0, 0, 102,
    6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2, 0, 1, 0, 0,
    0, 78, 161, 33, 0, 10, 64, 128, 253, 47, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0, 0, 0, 0, 64,
    223, 171, 255, 254, 132, 71, 191, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255, 255, 105, 6,
    0, 0, 105, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0, 80, 0, 0, 0, 20, 0, 2,
    0, 1, 0, 0, 0, 78, 161, 33, 0, 10, 64, 128, 253, 48, 0, 0, 0, 20, 0, 1, 0, 254, 128, 0, 0, 0,
    0, 0, 0, 180, 117, 151, 255, 254, 21, 252, 108, 20, 0, 6, 0, 255, 255, 255, 255, 255, 255, 255,
    255, 108, 6, 0, 0, 108, 6, 0, 0, 8, 0, 8, 0, 128, 0, 0, 0, 5, 0, 11, 0, 3, 0, 0, 0,
];

async fn receive_data<B>(to: &mut B) -> Result<usize, eyre::Report>
where
    B: BufMut,
{
    for (index, byte) in (KERNEL_DATA).iter().enumerate() {
        if index % 100 == 0 {
            sleep(Duration::from_nanos(1)).await;
        }

        to.put_u8(*byte);
    }

    Ok(KERNEL_DATA.len())
}

fn done() -> bool {
    true
}

fn main() {
    let result = tokio::runtime::Builder::new_multi_thread()
        .enable_io()
        .enable_time()
        .build()
        .expect("Failed building the Runtime")
        .block_on(async {
            // explicitly launch everything in a spawned task
            // see https://docs.rs/tokio/latest/tokio/attr.main.html#non-worker-async-function
            let handle = tokio::task::spawn(process_changes());

            flatten_handle(handle).await
        });

    if let Err(error) = result {
        eprintln!("{:?}", error);
    }
}

async fn process_changes() -> Result<(), eyre::Report> {
    // we originally had this on the stack (array) but tokio then moves the whole task to the heap because of size

    // we don't need to zero out the buffer between runs as `recv_buf` starts at 0 and returns `bytes_read`
    // sine we only read that portion we don't need to worry about the leftovers
    // Notice the 4 byte aligned buffer because all of our structs written here by the kernel
    // are aligned to 4 bytes
    let mut buffer = AlignedBuffer::<nlmsghdr, 4096>::new();

    loop {
        let bytes_read = {
            let mut buffer_byte_cursor = &mut *buffer;

            tokio::select! {
                result = receive_data(&mut buffer_byte_cursor) => {
                    result?
                },
            }
        };

        event!(
            Level::DEBUG,
            length = bytes_read,
            "netlink message received"
        );

        let buffer = {
            let raw_buffer = buffer.as_ref().as_ptr().cast::<u8>();

            // SAFETY: we are only initializing the parts of the buffer `recv_buf_from` has written to
            unsafe { std::slice::from_raw_parts(raw_buffer, bytes_read) }
        };

        if let Err(error) = parse_netlink_response(buffer).await {
            event!(
                Level::ERROR,
                ?error,
                "Error parsing response as a netlink response"
            );
        }

        if done() {
            break;
        }
    }

    Ok(())
}

async fn parse_netlink_response(buffer: &[u8]) -> Result<(), eyre::Report> {
    let mut remaining_bytes = buffer.len();

    let mut nlh_wrapper = SendPtr::from_start(buffer);

    while NLMSG_OK(nlh_wrapper.get_ptr(), remaining_bytes) {
        // SAFETY: `NLMSG_OK`
        let nlh = unsafe { &*nlh_wrapper.get_ptr() };

        let command = if nlh.nlmsg_type == RTM_NEWADDR {
            parse_address_message(nlh_wrapper.get_ptr()).map(|(ip_net, scope, index)| {
                Command::NewAddress {
                    address: ip_net,
                    scope,
                    index,
                }
            })
        } else if nlh.nlmsg_type == RTM_DELADDR {
            parse_address_message(nlh_wrapper.get_ptr()).map(|(ip_net, scope, index)| {
                Command::DeleteAddress {
                    address: ip_net,
                    scope,
                    index,
                }
            })
        } else if Into::<i32>::into(nlh.nlmsg_type) == NLMSG_DONE {
            None
        } else {
            event!(
                Level::DEBUG,
                "unhandled rtm_message type {}",
                nlh.nlmsg_type
            );

            None
        };

        if let Some(command) = command {
            tokio::time::sleep(Duration::from_nanos(1)).await;

            eprintln!("{:?}", command);
        }

        nlh_wrapper.mutate(|p| NLMSG_NEXT(p, &mut remaining_bytes));
    }

    Ok(())
}

fn parse_address_message(raw_nlh: *const nlmsghdr) -> Option<(IpNet, u8, u32)> {
    let raw_ifa = NLMSG_DATA::<ifaddrmsg>(raw_nlh);

    // SAFETY:`nlh` is valid, and has an `ifa`
    let ifa = unsafe { &*raw_ifa };

    let ifa_flags = u32::from(ifa.ifa_flags);

    if (ifa_flags & IFA_F_DADFAILED) != 0
        || (ifa_flags & IFA_F_HOMEADDRESS) != 0
        || (ifa_flags & IFA_F_DEPRECATED) != 0
        || (ifa_flags & IFA_F_TENTATIVE) != 0
    {
        event!(
            Level::DEBUG,
            "ignore address with invalid state {:#x}",
            ifa_flags
        );

        // skip this message and its data
        return None;
    }

    event!(
        Level::DEBUG,
        "RTM new/del addr family: {} flags: {} scope: {} idx: {}",
        ifa.ifa_family,
        ifa.ifa_flags,
        ifa.ifa_scope,
        ifa.ifa_index
    );

    let mut addr = None;

    let mut raw_rta = IFA_RTA(raw_ifa);
    let mut ifa_payload = IFA_PAYLOAD(raw_nlh);

    #[expect(clippy::big_endian_bytes, reason = "We're reading network data")]
    while RTA_OK(raw_rta, ifa_payload) {
        // SAFETY: See `RTA_OK`
        let rta = unsafe { &*raw_rta };

        event!(
            Level::DEBUG,
            "rt_attr type: {} {} ({})",
            rta.rta_len,
            rta.rta_type,
            rta.label().unwrap_or("Unknown type")
        );

        if rta.rta_type == IFA_ADDRESS && i32::from(ifa.ifa_family) == AF_INET6 {
            // SAFETY: Combination of `rta.rta_type` and `ifa.ifa_family`
            let ipv6_in_network_order = unsafe { &*RTA_DATA::<[u8; 16]>(raw_rta) };

            addr = Some(Ipv6Addr::from_bits(u128::from_be_bytes(*ipv6_in_network_order)).into());
        } else if rta.rta_type == IFA_LOCAL && i32::from(ifa.ifa_family) == AF_INET {
            // `libc::IFA_ADDRESS` is prefix address, rather than local interface address.
            // It makes no difference for normally configured broadcast interfaces,
            // but for point-to-point `libc::IFA_ADDRESS` is DESTINATION address,
            // local address is supplied in `libc::IFA_LOCAL` attribute.
            // https://github.com/torvalds/linux/blob/e9a6fb0bcdd7609be6969112f3fbfcce3b1d4a7c/include/uapi/linux/if_addr.h#L16-L25
            // SAFETY: Combination of `rta.rta_type` and `ifa.ifa_family`
            let ipv4_in_network_order = unsafe { &*RTA_DATA::<[u8; 4]>(raw_rta) };

            addr = Some(Ipv4Addr::from_bits(u32::from_be_bytes(*ipv4_in_network_order)).into());
        } else if rta.rta_type == IFA_LABEL {
            // unused, original codebase extracted
            // the labels in here for ipv4, but ipv6 requires another way
            // we do both the ipv6 way
        } else if rta.rta_type == IFA_FLAGS {
            // https://github.com/torvalds/linux/blob/febbc555cf0fff895546ddb8ba2c9a523692fb55/include/uapi/linux/if_addr.h#L35
            // unused
            // original:
            // _, ifa_flags = struct.unpack_from('HI', buf, i)
        } else {
            // other attributes are intentionally ignored
        }

        raw_rta = RTA_NEXT(raw_rta, &mut ifa_payload);
    }

    let Some(addr) = addr else {
        event!(Level::DEBUG, "no address in RTM message");

        return None;
    };

    Some((
        IpNet::new(addr, ifa.ifa_prefixlen)
            .expect("`prefix_len` must be valid for this address, as this is kernel data"),
        ifa.ifa_scope,
        ifa.ifa_index,
    ))
}
